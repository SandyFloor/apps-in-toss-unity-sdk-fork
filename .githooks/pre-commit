#!/bin/bash

# Unity .meta 파일 누락 검사 스크립트
# Unity 패키지의 Editor/, Runtime/ 디렉토리 내 파일들은 반드시 .meta 파일이 필요합니다.

set -e

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 체크할 디렉토리 목록 (Unity 패키지에서 .meta가 필요한 디렉토리)
UNITY_DIRS=("Editor" "Runtime" "WebGLTemplates")

# 제외할 파일/디렉토리 패턴
EXCLUDE_PATTERNS=(
    "*.meta"
    ".DS_Store"
    "*.swp"
    "*.tmp"
)

missing_meta_files=()

for dir in "${UNITY_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        # 디렉토리 내 모든 파일 검사 (숨김 파일 제외)
        while IFS= read -r -d '' file; do
            # 파일명만 추출
            filename=$(basename "$file")

            # 제외 패턴 확인
            skip=false
            for pattern in "${EXCLUDE_PATTERNS[@]}"; do
                if [[ "$filename" == $pattern ]]; then
                    skip=true
                    break
                fi
            done

            if [ "$skip" = true ]; then
                continue
            fi

            # .meta 파일이 존재하는지 확인
            meta_file="${file}.meta"
            if [ ! -f "$meta_file" ]; then
                missing_meta_files+=("$file")
            fi
        done < <(find "$dir" -type f ! -name ".*" -print0)
    fi
done

if [ ${#missing_meta_files[@]} -gt 0 ]; then
    echo -e "${RED}오류: Unity .meta 파일이 누락되었습니다!${NC}"
    echo ""
    echo "다음 파일들에 대한 .meta 파일이 없습니다:"
    for file in "${missing_meta_files[@]}"; do
        echo -e "  ${YELLOW}$file${NC}"
    done
    echo ""
    echo "해결 방법:"
    echo "  1. Unity Editor에서 프로젝트를 열어 자동으로 .meta 파일 생성"
    echo "  2. 또는 수동으로 .meta 파일 생성 (GUID 포함)"
    echo ""
    echo "커밋을 강제로 진행하려면: git commit --no-verify"
    exit 1
fi

echo "✓ Unity .meta 파일 검사 통과"
exit 0
